generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model GrandeFamille {
  id      String   @id @default(uuid())
  nom     String   @unique
  lignees Lignee[]
}

model Lignee {
  id                                 String                 @id @default(uuid())
  nom                                String                 @unique
  familleId                          String
  createdAt                          DateTime               @default(now())
  updatedAt                          DateTime               @updatedAt
  chefLigneeId                       String?
  cotisations                        CotisationLignee[]
  HistoriqueChefLignee               HistoriqueChefLignee[]
  Membre_Lignee_chefLigneeIdToMembre Membre?                @relation("Lignee_chefLigneeIdToMembre", fields: [chefLigneeId], references: [id])
  famille                            GrandeFamille          @relation(fields: [familleId], references: [id], map: "Lign├⌐e_familleId_fkey")
  membres                            Membre[]
}

model HistoriqueChefLignee {
  id        String    @id @default(uuid())
  ligneeId  String
  membreId  String
  dateDebut DateTime  @default(now())
  dateFin   DateTime?
  createdAt DateTime  @default(now())
  Lignee    Lignee    @relation(fields: [ligneeId], references: [id])
  Membre    Membre    @relation(fields: [membreId], references: [id])

  @@index([ligneeId])
  @@index([membreId])
}

model Membre {
  id                                 String                 @id @default(uuid())
  nom                                String
  prenoms                            String
  genre                              String
  dateNaissance                      DateTime?
  photo                              String?
  categorieId                        String?
  createdAt                          DateTime               @default(now())
  ligneeId                           String
  updatedAt                          DateTime?              @updatedAt
  statutMembre                       String                 @default("Actif")
  contact1                           String?
  contact2                           String?
  email                              String?
  cotisations                        Cotisation[]
  deces                              Deces?
  HistoriqueChefLignee               HistoriqueChefLignee[]
  Lignee_Lignee_chefLigneeIdToMembre Lignee[]               @relation("Lignee_chefLigneeIdToMembre")
  categorie                          Categorie?             @relation(fields: [categorieId], references: [id])
  lignee                             Lignee                 @relation(fields: [ligneeId], references: [id])

  @@unique([nom, prenoms], name: "nom_prenoms_unique")
}

model Categorie {
  id                        String    @id @default(uuid())
  label                     String
  generation                String
  classe                    String
  born_from                 Int?
  born_to                   Int?
  date_sortie_1er_guerrier  DateTime
  date_sortie_2eme_guerrier DateTime?
  description               String?
  membres                   Membre[]
}

model Deces {
  id                String             @id @default(uuid())
  membreId          String             @unique
  dateDeces         DateTime
  motif             String?
  cotisations       Cotisation[]
  cotisationsLignee CotisationLignee[]
  membre            Membre             @relation(fields: [membreId], references: [id])
  enterrement       Enterrement?
}

/// -------------------------------------------------------
/// ENTERREMENT
/// -------------------------------------------------------
model Enterrement {
  id                   String    @id @default(uuid())
  decesId              String    @unique
  declareAuVillage     Boolean   @default(false)
  funeraillesAuVillage Boolean   @default(false)
  enterreAuVillage     Boolean   @default(false)
  lieuEnterrement      String?
  dateEnterrement      DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  deces                Deces     @relation(fields: [decesId], references: [id])
}

model Cotisation {
  id               Int        @id @default(autoincrement())
  membreId         String
  date             DateTime
  montant          Int
  motif            String?
  createdAt        DateTime   @default(now())
  paidAt           DateTime?
  decesId          String?
  statutCotisation String     @default("Impaye")
  deces            Deces?     @relation(fields: [decesId], references: [id])
  membre           Membre     @relation(fields: [membreId], references: [id])
  paiements        Paiement[]

  @@unique([membreId, decesId], name: "cotisation_unique_par_deces")
}

model Paiement {
  id           Int        @id @default(autoincrement())
  cotisationId Int
  montant      Int
  date         DateTime   @default(now())
  mode         String?
  createdAt    DateTime   @default(now())
  cotisation   Cotisation @relation(fields: [cotisationId], references: [id])
}

model CotisationLignee {
  id        Int              @id @default(autoincrement())
  date      DateTime         @default(now())
  montant   Int
  motif     String?
  statut    String           @default("Impaye")
  decesId   String
  ligneeId  String
  createdAt DateTime         @default(now())
  paidAt    DateTime?
  deces     Deces            @relation(fields: [decesId], references: [id])
  lignee    Lignee           @relation(fields: [ligneeId], references: [id])
  paiements PaiementLignee[]

  @@unique([decesId, ligneeId])
}

model PaiementLignee {
  id               Int              @id @default(autoincrement())
  cotisationId     Int
  montant          Int
  date             DateTime         @default(now())
  mode             String?
  createdAt        DateTime         @default(now())
  cotisationLignee CotisationLignee @relation(fields: [cotisationId], references: [id])
}

model SettingCategory {
  id       Int       @id @default(autoincrement())
  name     String
  code     String    @unique
  settings Setting[]
}

model Setting {
  id         Int             @id @default(autoincrement())
  key        String          @unique
  label      String
  value      String?
  type       String
  meta       String?
  categoryId Int
  updatedAt  DateTime        @updatedAt
  minRole    String?
  visible    Boolean         @default(true)
  category   SettingCategory @relation(fields: [categoryId], references: [id])
}

model User {
  id            Int          @id @default(autoincrement())
  email         String?      @unique
  role          String       @default("user")
  createdAt     DateTime     @default(now())
  active        Boolean      @default(true)
  password      String
  updatedAt     DateTime     @updatedAt
  username      String       @unique
  amendesCreees Amende[]
  Communique    Communique[]
}

model MenuGroup {
  id      Int        @id @default(autoincrement())
  name    String
  code    String     @unique
  order   Int        @default(0)
  visible Boolean    @default(true)
  items   MenuItem[]
}

model MenuItem {
  id       Int        @id @default(autoincrement())
  label    String
  path     String?    @unique
  icon     String?
  order    Int        @default(0)
  visible  Boolean    @default(true)
  minRole  String     @default("user")
  groupId  Int?
  parentId Int?
  group    MenuGroup? @relation(fields: [groupId], references: [id])
  parent   MenuItem?  @relation("MenuItemToMenuItem", fields: [parentId], references: [id])
  children MenuItem[] @relation("MenuItemToMenuItem")
}

model Communique {
  id                  String                @id @default(uuid())
  titre               String
  contenu             String
  type                CommuniqueType
  statut              CommuniqueStatut
  canaux              String[]
  cibleType           CibleType
  cibleIds            String[]
  datePublication     DateTime?
  dateArchivage       DateTime?
  createdById         Int
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  User                User                  @relation(fields: [createdById], references: [id])
  DiffusionBatch      DiffusionBatch[]
  DiffusionHistorique DiffusionHistorique[]

  @@index([datePublication])
}

model DiffusionHistorique {
  id             String          @id @default(uuid())
  communiqueId   String
  canal          CanalDiffusion
  destinataire   String
  statut         DiffusionStatut
  messageRetour  String?
  sentAt         DateTime        @default(now())
  batchId        String

  // NOUVEAUX CHAMPS POUR LES SMS ORANGE
  trackingUrl    String?         // URL de suivi Orange
  messageId      String?         // ID unique du message

  DiffusionBatch DiffusionBatch  @relation(fields: [batchId], references: [id], onDelete: Cascade)
  Communique     Communique      @relation(fields: [communiqueId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@index([canal])
  @@index([communiqueId])
  @@index([statut])
}

model DiffusionBatch {
  id                  String                @id
  communiqueId        String
  type                DiffusionType
  totalCibles         Int
  totalEnvoyes        Int
  totalEchecs         Int
  startedAt           DateTime              @default(now())
  finishedAt          DateTime?
  Communique          Communique            @relation(fields: [communiqueId], references: [id], onDelete: Cascade)
  DiffusionHistorique DiffusionHistorique[]

  @@index([communiqueId])
  @@index([type])
}

model Amende {
  id           String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  reference    String           @unique
  type         amende_type
  motif        String
  montant      Int?
  description  String
  dateDecision DateTime         @default(now()) @db.Timestamp(6)
  dateLimite   DateTime?        @db.Timestamp(6)
  statut       amende_statut    @default(EN_ATTENTE)
  createdById  Int
  createdAt    DateTime         @default(now()) @db.Timestamp(6)
  updatedAt    DateTime         @default(now()) @updatedAt @db.Timestamp(6)
  createdBy    User             @relation(fields: [createdById], references: [id], onUpdate: NoAction, map: "Amende_createdBy_fkey")
  cibles       AmendeCible[]
  paiements    AmendePaiement[]
  relances     AmendeRelance[]
}

model AmendeCible {
  id            String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type          amende_cible_type
  cibleId       String
  cibleNom      String
  ciblePrenom   String
  amendeId      String            @db.Uuid
  estTransferee Boolean           @default(false)
  amende        Amende            @relation(fields: [amendeId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "AmendeCible_amende_fkey")
}

model AmendePaiement {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  montant      Int
  datePaiement DateTime @default(now()) @db.Timestamp(6)
  mode         String?
  amendeId     String   @db.Uuid
  reference    String?
  amende       Amende   @relation(fields: [amendeId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "AmendePaiement_amende_fkey")
}

model AmendeRelance {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  canal     String
  message   String?
  dateEnvoi DateTime @default(now()) @db.Timestamp(6)
  amendeId  String   @db.Uuid
  amende    Amende   @relation(fields: [amendeId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "AmendeRelance_amende_fkey")
}

enum CommuniqueType {
  GRIOT
  REUNION
  CONVOCATION
  DECES
  COTISATION
  GENERAL
}

enum CommuniqueStatut {
  BROUILLON
  PUBLIE
  ARCHIVE
}

enum CibleType {
  ALL
  FAMILLE
  LIGNEE
  CATEGORIE
  CUSTOM
}

enum CanalDiffusion {
  GRIOT
  SMS
  EMAIL
  WHATSAPP
  PUSH
}

enum DiffusionStatut {
  ENVOYE
  ECHEC
}

enum DiffusionType {
  PUBLICATION
  REDIFFUSION
}

enum amende_cible_type {
  INDIVIDU
  LIGNEE
  CATEGORIE
  GENERATION
}

enum amende_statut {
  EN_ATTENTE
  PARTIEL
  PAYEE
  TRANSFEREE
  IMPAYEE
}

enum amende_type {
  PECUNIAIRE
  MATERIELLE
  DISCIPLINAIRE
  MIXTE
}
