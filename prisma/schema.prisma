generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// -------------------------------------------------------
/// GRANDE FAMILLE
/// -------------------------------------------------------

model GrandeFamille {
  id      String   @id @default(uuid())
  nom     String   @unique
  lignees Lignee[]

}

/// -------------------------------------------------------
/// LIGNEE (chef + historique)
/// -------------------------------------------------------

model Lignee {
  id           String   @id @default(uuid())
  nom          String   @unique
  familleId    String
  chefLigneeId String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  famille      GrandeFamille @relation(fields: [familleId], references: [id])
  membres      Membre[]
  cotisations  CotisationLignee[]

  chefLignee Membre? @relation("ChefLigneeActuel", fields: [chefLigneeId], references: [id])

  historiques  HistoriqueChefLignee[]
}

/// -------------------------------------------------------
/// HISTORIQUE CHEF DE LIGNEE
/// -------------------------------------------------------

model HistoriqueChefLignee {
  id        String   @id @default(uuid())
  ligneeId  String   
  membreId  String   
  dateDebut DateTime @default(now())
  dateFin   DateTime?
  createdAt DateTime @default(now())

  lignee    Lignee @relation(fields: [ligneeId], references: [id])
  membre    Membre @relation(fields: [membreId], references: [id])

  @@index([ligneeId])
  @@index([membreId])
}


/// -------------------------------------------------------
/// MEMBRE
/// -------------------------------------------------------

model Membre {
  id            String   @id @default(uuid())
  nom           String
  prenoms       String
  genre         String
  dateNaissance DateTime?
  photo         String?
  categorieId   String?
  ligneeId      String
  createdAt     DateTime @default(now())
  updatedAt     DateTime? @updatedAt

  statutMembre  String   @default("Actif")
  contact1      String?
  contact2      String?
  email         String?

  lignee        Lignee   @relation(fields: [ligneeId], references: [id])
  categorie     Categorie? @relation(fields: [categorieId], references: [id])

  cotisations   Cotisation[]
  deces         Deces?

  // Chef ACTUEL dâ€™une lignÃ©e (0 ou 1)
  chefferiesActuelles Lignee[] @relation("ChefLigneeActuel")


  // Historique des chefferies
  chefferies    HistoriqueChefLignee[]

  @@unique([nom, prenoms], name: "nom_prenoms_unique")
}

/// -------------------------------------------------------
/// CATEGORIE
/// -------------------------------------------------------

model Categorie {
  id                        String   @id @default(uuid())
  label                     String
  generation                String
  classe                    String
  born_from                 Int?
  born_to                   Int?
  date_sortie_1er_guerrier  DateTime
  date_sortie_2eme_guerrier DateTime?
  description               String?

  membres                   Membre[]
}

/// -------------------------------------------------------
/// DECES
/// -------------------------------------------------------

model Deces {
  id                String   @id @default(uuid())
  membreId          String   @unique
  dateDeces         DateTime
  motif             String?

  membre            Membre   @relation(fields: [membreId], references: [id])
  cotisations       Cotisation[]
  cotisationsLignee CotisationLignee[]
  enterrement       Enterrement?
}

/// -------------------------------------------------------
/// ENTERREMENT
/// -------------------------------------------------------
model Enterrement {
  id                   String    @id @default(uuid())
  decesId              String    @unique
  declareAuVillage     Boolean   @default(false)
  funeraillesAuVillage Boolean   @default(false)
  enterreAuVillage     Boolean   @default(false)
  lieuEnterrement      String?
  dateEnterrement      DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  deces                Deces     @relation(fields: [decesId], references: [id])
}

/// -------------------------------------------------------
/// COTISATION MEMBRE
/// -------------------------------------------------------

model Cotisation {
  id               Int      @id @default(autoincrement())
  membreId         String
  decesId          String?

  date             DateTime
  montant          Int
  motif            String?
  statutCotisation String   @default("Impaye")
  createdAt        DateTime @default(now())
  paidAt           DateTime?

  membre           Membre   @relation(fields: [membreId], references: [id])
  deces            Deces?   @relation(fields: [decesId], references: [id])
  paiements        Paiement[]

  @@unique([membreId, decesId], name: "cotisation_unique_par_deces")
}

/// -------------------------------------------------------
/// PAIEMENT MEMBRE
/// -------------------------------------------------------

model Paiement {
  id           Int      @id @default(autoincrement())
  cotisationId Int
  montant      Int
  date         DateTime @default(now())
  mode         String?
  createdAt    DateTime @default(now())

  cotisation   Cotisation @relation(fields: [cotisationId], references: [id])
}

/// -------------------------------------------------------
/// COTISATION PAR LIGNEE
/// -------------------------------------------------------

model CotisationLignee {
  id         Int      @id @default(autoincrement())
  decesId    String
  ligneeId   String

  date       DateTime @default(now())
  montant    Int
  motif      String?
  statut     String   @default("Impaye")
  createdAt  DateTime @default(now())
  paidAt     DateTime?

  deces      Deces    @relation(fields: [decesId], references: [id])
  lignee     Lignee   @relation(fields: [ligneeId], references: [id])
  paiements  PaiementLignee[]

  @@unique([decesId, ligneeId])
}

/// -------------------------------------------------------
/// PAIEMENT LIGNEE
/// -------------------------------------------------------

model PaiementLignee {
  id               Int      @id @default(autoincrement())
  cotisationId     Int
  montant          Int
  date             DateTime @default(now())
  mode             String?
  createdAt        DateTime @default(now())

  cotisationLignee CotisationLignee @relation(fields: [cotisationId], references: [id])
}

/// -------------------------------------------------------
/// SETTINGS
/// -------------------------------------------------------

model SettingCategory {
  id       Int       @id @default(autoincrement())
  name     String
  code     String    @unique
  settings Setting[]
}

model Setting {
  id         Int             @id @default(autoincrement())
  key        String          @unique
  label      String
  value      String?
  type       String
  meta       String?
  categoryId Int
  updatedAt  DateTime        @updatedAt
  minRole    String?
  visible    Boolean         @default(true)

  category   SettingCategory @relation(fields: [categoryId], references: [id])
}

/// -------------------------------------------------------
/// USER & MENU
/// -------------------------------------------------------

model User {
  id        Int      @id @default(autoincrement())
  email     String?  @unique
  username  String   @unique
  password  String
  role      String   @default("user")
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  communiques Communique[]
}

model MenuGroup {
  id      Int        @id @default(autoincrement())
  name    String
  code    String     @unique
  order   Int        @default(0)
  visible Boolean    @default(true)
  items   MenuItem[]
}

model MenuItem {
  id       Int        @id @default(autoincrement())
  label    String
  path     String?    @unique
  icon     String?
  order    Int        @default(0)
  visible  Boolean    @default(true)
  minRole  String     @default("user")
  groupId  Int?
  parentId Int?

  group    MenuGroup? @relation(fields: [groupId], references: [id])
  parent   MenuItem?  @relation("MenuItemToMenuItem", fields: [parentId], references: [id])
  children MenuItem[] @relation("MenuItemToMenuItem")
}


/// -------------------------------------------------------
/// COMMUNICATIONS
/// -------------------------------------------------------

model Communique {
  id              String   @id @default(uuid())

  titre           String
  contenu         String

  type            CommuniqueType
  statut          CommuniqueStatut

  canaux          String[]
  cibleType       CibleType
  cibleIds        String[]

  datePublication DateTime?
  dateArchivage   DateTime?

  createdById     Int
  createdBy       User     @relation(fields: [createdById], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  diffusions      DiffusionHistorique[]
  batches         DiffusionBatch[]      // ðŸ‘ˆ NOUVEAU

  @@index([datePublication])
}


model DiffusionBatch {
  id             String   @id @default(uuid())

  communiqueId   String
  communique     Communique @relation(fields: [communiqueId], references: [id], onDelete: Cascade)

  type           DiffusionType   // PUBLICATION | REDIFFUSION

  totalCibles    Int
  totalEnvoyes   Int
  totalEchecs    Int

  startedAt      DateTime @default(now())
  finishedAt     DateTime?

  diffusions     DiffusionHistorique[]

  @@index([communiqueId])
  @@index([type])
}


model DiffusionHistorique {
  id             String   @id @default(uuid())

  communiqueId   String
  communique     Communique @relation(fields: [communiqueId], references: [id], onDelete: Cascade)

  batchId        String
  batch          DiffusionBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  canal          CanalDiffusion
  destinataire   String
  statut         DiffusionStatut
  messageRetour  String?

  sentAt         DateTime @default(now())

  @@index([communiqueId])
  @@index([batchId])
  @@index([canal])
  @@index([statut])
}




/// -------------------------------------------------------
/// ENUMS â€“ COMMUNICATIONS
/// -------------------------------------------------------

enum CommuniqueType {
  GRIOT
  REUNION
  CONVOCATION
  DECES
  COTISATION
  GENERAL
}

enum CommuniqueStatut {
  BROUILLON
  PUBLIE
  ARCHIVE
}

enum CibleType {
  ALL
  FAMILLE
  LIGNEE
  CATEGORIE
  CUSTOM
}

enum CanalDiffusion {
  GRIOT
  SMS
  EMAIL
  WHATSAPP
  PUSH
}

enum DiffusionStatut {
  ENVOYE
  ECHEC
}

enum DiffusionType {
  PUBLICATION
  REDIFFUSION
}

